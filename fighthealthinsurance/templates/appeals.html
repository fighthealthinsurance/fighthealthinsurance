{% extends 'base.html' %}
{% load static %}
{% block title %}
Fight Your Health Insurance Denial: Choose an Appeal
{% endblock title %}

{% block pre-roll %}
<script src='{% static "js/dist/appeal_fetcher.bundle.js" %}' defer></script>
{% endblock pre-roll %}

{% block content %}

<div class="container" style="padding-top:1rem;">
  <!-- Progress indicator -->
  {% include 'partials/flow_progress.html' with current_step=current_step|default:7 %}
</div>

<!-- Loading Spinner -->
<div id="loading-text" style="text-align:center; padding:1rem;">
  <h2 style="color:#333;">Generating Your Appeals</h2>
  <p style="color:#666;">Please wait while we create personalized appeal options for you...</p>
</div>
<div id="loading-spinner">
</div>

  <!-- Main Content -->
<div id="main-content" class="generic-main-content">
  <div id="loading-more">
    <h4>Brewing Your Appeals ‚òï</h4>
    <p>We're generating your personalized health insurance appeals. This usually takes 1-3 minutes. Our AI is reading your denial, getting appropriately angry, and drafting multiple appeals for you to choose from.</p>

    <div style="text-align: center; margin: 2rem 0;">
      <img src="{% static 'images/timbit-stand-on-keyboard-optimized.jpg' %}" alt="Timbit standing on a keyboard" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" width="1200" height="891">
      <p style="margin-top: 1rem; font-style: italic; color: #666;">Professor Timbit supervising the AI (that's Holden and Carolyn's dog)</p>
    </div>

    <h5>Why does this take time?</h5>
    <p>Our AI needs to:</p>
    <ul>
      <li>üìñ Understand your specific denial</li>
      <li>üîç Research relevant medical literature and policy language</li>
      <li>‚úçÔ∏è Craft 3 different appeal approaches tailored to your case</li>
      <li>üéØ Make each one persuasive and professional</li>
    </ul>
    <p>Unlike ChatGPT or other generic AI tools, we're specialized in fighting insurance denials‚Äîwhich means better quality appeals, but a bit more processing time.</p>

    <h5>What you'll get:</h5>
    <ul>
      <li><strong>3 Different Appeals:</strong> We generate multiple versions so you can pick the one that feels right for your situation</li>
      <li><strong>Ready to Submit:</strong> Each appeal is complete and professionally formatted</li>
      <li><strong>Fully Editable:</strong> You can customize any appeal before submitting</li>
    </ul>

    <h5>Taking longer than expected?</h5>
	<ul>
	<li><strong>First refresh:</strong> After 3-5 minutes, try refreshing the page (hold Shift while clicking refresh). We'll generate a fresh batch of appeals.</li>
	<li><strong>Still waiting?</strong> Check if you have ad blockers or JavaScript blockers enabled‚Äîthese can interfere with the generation process.</li>
	<li><strong>Need help?</strong> If nothing works after a few tries, our servers (lovingly named Plushy and Steve) might be taking a nap. Email us at <a href="mailto:support42@fighthealthinsurance.com">support42@fighthealthinsurance.com</a> and we'll investigate!</li>
	</ul>
	</div>

<p>
  When you choose a specific appeal, we <b>save that appeal to our database for model training and review</b>.
</p>
<div id="base-form" style="display: none;">
<form action="{% url 'choose_appeal' %}" method="post" class="col-md-12 d-flex flex-column align-items-center" id="form">
  {% csrf_token %}
  <input type="hidden" name="email" value="{{ user_email }}">
  <input type="hidden" name="denial_id" value="{{ denial_id }}">
  <input type="hidden" name="semi_sekret" value="{{ semi_sekret }}">
  <textarea style="width:100%" rows="20" name="appeal_text" id="appeal_text">
  </textarea>

  <button type="submit" id="submit" class="btn btn-green">Choose This One</button>
</form>
</div>
<div id="output-container">
</div>

<div class="form-nav-centered">
  {% if back_url %}
  <a href="{{ back_url }}" class="btn btn-secondary-custom">
    ‚Üê {{ back_label|default:"Back" }}
  </a>
  {% endif %}
  <a href="{% url 'scan' %}" class="btn-link-muted">
    Start over with a new denial
  </a>
</div>

<div class="appeals-share-wrapper">
  {% include 'partials/share_buttons.html' %}
</div>
</div>  <!-- Close generic-main-content -->

<script>
  // Call the typescript on load
  document.addEventListener('DOMContentLoaded', () => {
      const backendUrl = `wss://${window.location.host}/ws/streaming-appeals-backend/`;
      const data = {
	  {% autoescape off %}
          ...{{form_context}},
          {% endautoescape %}
          ...{
              'csrfmiddlewaretoken': '{{ csrf_token }}',
              'timbit': 'is most awesomex2'}}

      // Call the doQuery function
      doQuery(backendUrl, data);
  });
</script>
{% endblock content %}
