{% extends 'base.html' %}
{% load static %}
{% block scriptmagic %}
<script type="module">
  import * as main from '{% static "js/dist/appeal.bundle.js" %}';
</script>
{% endblock scriptmagic %}
{% block title %}
Fight Your Health Insurance Denial: Edit and send in your appeal
{% endblock title %}

{% block content %}
<!-- PWYW Panel at Top -->
<section id="pwyw-panel-appeal">
    <div class="container">
	<div class="row justify-content-center">
	    <div class="col-md-10">
		<h3 class="text-center">Appreciate us? Pay What You Want (Optional)</h3>
		<p class="text-center pwyw-description">
		  If we saved you time or money, consider supporting us. It helps keep this tool free for everyone!
		</p>
		<div class="pwyw-options">
		    <a href="javascript:void(0)" class="pwyw-option pwyw-free" onclick="handleAppealDonation(event, '0')">
			<div class="pwyw-amount">$0</div>
			<div class="pwyw-label">I need this free</div>
		    </a>
		    <a href="#" class="pwyw-option" onclick="handleAppealDonation(event, '10')">
			<div class="pwyw-amount">$10</div>
			<div class="pwyw-label">Cover an SF coffee</div>
		    </a>
		    <a href="#" class="pwyw-option" onclick="handleAppealDonation(event, '25')">
			<div class="pwyw-amount">$25</div>
			<div class="pwyw-label">Help another appeal</div>
		    </a>
		    <a href="#" class="pwyw-option" onclick="handleCustomAppealDonation(event)">
			<div class="pwyw-amount">Custom</div>
			<div class="pwyw-label">Choose your amount</div>
		    </a>
		</div>
	    </div>
	</div>
    </div>
</section>

<script>
function handleAppealDonation(event, amount) {
    event.preventDefault();
    
    fetch("{% url 'pwyw_donation' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            amount: amount,
            cancel_url: window.location.pathname
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (data.checkout_url) {
                window.location.href = data.checkout_url;
            } else if (data.message) {
                alert(data.message);
            }
        } else if (data.error) {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function handleCustomAppealDonation(event) {
    event.preventDefault();
    
    const amount = prompt('Enter your donation amount (in USD):');
    if (amount && amount.trim()) {
        handleAppealDonation(event, amount.trim());
    }
}
</script>

<div class="container" style="margin-top: 30px;">
Huzzah! We have a <b>draft</b> appeal for you to edit below:

<form action="{% url 'share_appeal' %}" method="post" class="col-md-12 d-flex flex-column align-items-center">
  {% csrf_token %}
  <input type="hidden" name="email" value="{{ user_email }}">
  <input type="hidden" name="denial_id" value="{{ denial_id }}">
  
  <textarea class="appeal_text" name="appeal_text" id="scrubbed_appeal_text">
    {{appeal}}
  </textarea>

  <!-- <button type="submit" class="btn btn-green">(Optional) Upload and Share (do not include PII)</button> -->
</form>
<button id="descrub" class="btn btn-green">
  Fill in your PII
</button>


<p>
  Once your satisified it's time to send in your appeal! Your denial should include the mailing address or fax number to submit your appeal to.
</p>
<p>
  {{appeal_info_extracted}}
</p>
<p>
  We can try and send the fax for you (pay what you want) if you want, but know you can send it in other ways.
</p>
<p>
  Note: Faxing your appeal with us does temporarily store the full filled in appeal on our servers (and potentially fax partners). Your e-mail will also be stored temporarily.
</p>
<!-- Put this back once we write that java script. -->
<form action="{% url 'stagefaxview' %}" method="post" class="col-md-12 d-flex flex-column align-items-center">
  {% csrf_token %}
  {{ fax_form }}
  <button id="fax_appeal">
    Fax Appeal (Pay What You Want)
  </button>
</form>
<!--
<button id="generate_pdf">
  Generate PDF (limited to 1 page)
</button>
-->
<br>
or:
<button id="print_appeal">
  Print Appeal (self submit)
</button>
</div>

<!-- PWYW Panel at Bottom -->
<section id="pwyw-panel-appeal-bottom">
    <div class="container">
	<div class="row justify-content-center">
	    <div class="col-md-10">
		<h3 class="text-center">Appreciate us? Pay What You Want (Optional)</h3>
		<p class="text-center pwyw-description">
		  If we saved you time or money, consider supporting us. It helps keep this tool free for everyone!
		</p>
		<div class="pwyw-options">
		    <a href="javascript:void(0)" class="pwyw-option pwyw-free" onclick="handleAppealDonation(event, '0')">
			<div class="pwyw-amount">$0</div>
			<div class="pwyw-label">I need this free</div>
		    </a>
		    <a href="#" class="pwyw-option" onclick="handleAppealDonation(event, '10')">
			<div class="pwyw-amount">$10</div>
			<div class="pwyw-label">Cover an SF coffee</div>
		    </a>
		    <a href="#" class="pwyw-option" onclick="handleAppealDonation(event, '25')">
			<div class="pwyw-amount">$25</div>
			<div class="pwyw-label">Help another appeal</div>
		    </a>
		    <a href="#" class="pwyw-option" onclick="handleCustomAppealDonation(event)">
			<div class="pwyw-amount">Custom</div>
			<div class="pwyw-label">Choose your amount</div>
		    </a>
		</div>
	    </div>
	</div>
    </div>
</section>

<p>
* We'll do our best to include a summary or abstract if available from PubMed.
</p>
{% endblock content %}
