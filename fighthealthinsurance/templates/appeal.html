{% extends 'base.html' %}
{% load static %}
{% block scriptmagic %}
<script type="module">
  import * as main from '{% static "js/dist/appeal.bundle.js" %}';
</script>
<script src="{% static 'js/pwyw.js' %}"></script>
{# UET tracking for Stripe links handled by base.html #}
{% endblock scriptmagic %}
{% block title %}
Fight Your Health Insurance Denial: Edit and send in your appeal
{% endblock title %}

{% block content %}
<div class="container" style="padding-top:1rem;">
  <!-- Progress indicator -->
  {% include 'partials/flow_progress.html' with current_step=current_step|default:8 %}
</div>

<div class="alert-box alert-success">
  <h3>üéâ Your Appeal is Ready!</h3>
  <p style="font-size:1.1rem;"><strong>Thank you for trusting us to help you fight your denial.</strong> We've drafted your appeal letter below. Please review and improve it with your personal details and story, then submit it to your insurance company!</p>
</div>

<div class="alert-box alert-danger">
  <h4>‚ö†Ô∏è Save a Copy RIGHT NOW!</h4>
  <p style="font-size:1.05rem;"><strong>Before you do anything else, save a copy of your appeal!</strong> Computers can crash, browsers can freeze, and connections can drop. Copy the text below and save it somewhere safe (email it to yourself, save to a document, etc.) so you don't lose your work.</p>
</div>

<div class="alert-box alert-warning">
  <h4 style="margin-bottom:1rem;">üìã What to Do Next - Simple 2-Step Process:</h4>
  <div style="margin-left: 1.5rem;">
    <p style="margin:0.5rem 0;"><strong>Step 1:</strong> Review, edit, and improve the appeal letter below - add your personal information and any additional details that strengthen your case</p>
    <p style="margin:0.5rem 0;"><strong>Step 2:</strong> Send your appeal using one of the options below (we explain each one!)</p>
  </div>
</div>

<div class="appeal-donate-wrapper donate-wrapper">
  <p style="color: #333; margin-bottom: 1rem;">
    <strong>üíô Help us help others:</strong> Fight Health Insurance is completely free. If we've helped you, please consider supporting our work so we can help more people:
    <a href="https://buy.stripe.com/5kA03r2ZwbgebyE7ss" class="section-btn btn btn-default smoothScroll" id="support-our-dev-button" target="_blank" rel="noopener noreferrer">
      Pay What You Want (optional)
    </a>
  </p>
  {% include 'partials/pwyw_panel.html' %}
</div>

<h3 class="section-header">Step 1: Review, Edit, and Improve Your Appeal</h3>
<p style="font-size:1.05rem;"><strong>Important:</strong> Take time to review and edit the appeal letter below. Click the "Fill in your PII" button to add your personal information (name, address, etc.), and feel free to add or modify any details that strengthen your case. The more personalized and detailed your appeal, the better!</p>

<form action="{% url 'share_appeal' %}" method="post" class="col-md-12 d-flex flex-column align-items-center">
  {% csrf_token %}
  <input type="hidden" name="email" value="{{ user_email }}">
  <input type="hidden" name="denial_id" value="{{ denial_id }}">
  
  <textarea class="appeal_text" name="appeal_text" id="scrubbed_appeal_text">
    {{appeal}}
  </textarea>

  <!-- <button type="submit" class="btn btn-green">(Optional) Upload and Share (do not include PII)</button> -->
</form>
<button id="descrub" class="btn btn-green" style="font-size:1.1rem; padding:12px 24px; margin:1rem 0;">
  ‚úèÔ∏è Fill in your PII (Personal Information)
</button>

<h3 class="section-header section-header-spacing">Step 2: Send Your Appeal to Your Insurance Company</h3>

<div class="alert-box alert-info">
  <h4 style="margin-bottom:1rem;">üì¨ How to Submit Your Appeal - Choose What Works Best For You:</h4>
  <p style="margin:0.5rem 0;">Your denial letter should include the mailing address or fax number where you need to send your appeal. Choose one of these options:</p>
</div>

<div style="margin:1.5rem 0;">
  <h4 class="option-header">‚úÖ Option 1: We'll Fax It For You (Easiest!)</h4>
  <p class="option-content">
    We can send the fax directly to your insurance company. This is the quickest and easiest option. You can pay what you want - even $0 if you need it free!
  </p>
  <p class="option-note">
    <strong>Note:</strong> When we fax for you, your completed appeal (including personal information) is temporarily stored on our servers and our fax partner's servers to complete the transmission.
  </p>

<form action="{% url 'stagefaxview' %}" method="post" class="col-md-12 d-flex flex-column align-items-center form-wrapper">
  {% csrf_token %}
  {{fax_form}}
  <div class="fax-pwyw-group" aria-label="Fax price (optional, pay what you want)" style="margin:1rem 0;">
    <label><input type="radio" name="fax_pwyw" value="0" checked>$0 <small>Need it free</small></label>
    <label><input type="radio" name="fax_pwyw" value="5">$5 <small>Original price</small></label>
    <label><input type="radio" name="fax_pwyw" value="10">$10 <small>Keep lights on</small></label>
    <label><input type="radio" name="fax_pwyw" value="custom">Custom
      <input type="number" min="1" max="1000" step="1" class="fax-custom-input" name="fax_amount_custom" placeholder="Amount" aria-label="Custom fax amount">
    </label>
  </div>
  <input type="hidden" name="fax_amount" value="0">
  <button id="fax_appeal" class="btn-green" style="font-size:1.1rem; padding:12px 24px;">
    üì† Fax My Appeal (Pay What You Want)
  </button>
</form>
</div>

<div style="margin:2rem 0;">
  <h4 class="option-header">‚úÖ Option 2: Print and Mail It Yourself</h4>
  <p class="option-content">
    Click the "Print Appeal" button below to print your appeal letter. Then mail it to the address shown on your denial letter.
    <strong>We recommend using certified mail</strong> so you have proof of delivery.
  </p>
  <button id="print_appeal" class="btn" style="font-size:1.1rem; padding:12px 24px; margin-left:1.5rem;">
    üñ®Ô∏è Print My Appeal (to mail yourself)
  </button>
</div>

<div style="margin:2rem 0;">
  <h4 class="option-header">‚úÖ Option 3: Use a Free Fax Service</h4>
  <p class="option-content">
    You can also fax your appeal yourself using free online fax services. Here are some options:
  </p>
  <ul style="margin-left:3rem; line-height:1.8;">
    <li><strong><a href="https://faxzero.com" target="_blank" rel="noopener noreferrer">FaxZero</a></strong> - Free for up to 5 pages (includes cover page), 3 faxes per day</li>
    <li><strong><a href="https://www.hellofax.com" target="_blank" rel="noopener noreferrer">HelloFax</a></strong> - Free trial available (5 pages/month)</li>
    <li><strong><a href="https://www.gotfreefax.com" target="_blank" rel="noopener noreferrer">GotFreeFax</a></strong> - Free faxing with ads</li>
    <li><strong><a href="https://www.faxburner.com" target="_blank" rel="noopener noreferrer">FaxBurner</a></strong> - Free with mobile app (limited pages)</li>
  </ul>
  <p style="margin:0.5rem 0 1rem 1.5rem; font-size:0.95rem; color:#666;">
    To use these services: Print or save your appeal as a PDF, then upload it to one of these websites along with the fax number from your denial letter.
  </p>
</div>

<div class="alert-box alert-warning" style="margin:2rem 0;">
  <h4>üí° Important Reminders:</h4>
  <ul style="margin:0.5rem 0 0 1.5rem; line-height:1.8;">
    <li><strong>Save a copy:</strong> Download or save a copy of your completed appeal for your records before submitting. Computers and fax machines can be unreliable!</li>
    <li><strong>Confirm receipt:</strong> After submitting (by mail or fax), call your insurance company to confirm they received your appeal. Keep a note of who you spoke with and when.</li>
    <li><strong>Be ready to help:</strong> If they claim they "didn't receive it," you'll have your saved copy ready to resend immediately.</li>
    <li><strong>Keep proof:</strong> Save tracking numbers (for mail) or fax confirmation pages as proof of submission.</li>
  </ul>
</div>

<p>
  {{appeal_info_extracted}}
</p>

<!--
<button id="generate_pdf">
  Generate PDF (limited to 1 page)
</button>
-->
<div class="alert-box alert-success" style="margin:2rem 0; text-align:center;">
  <h4>üôè Thank You for Trusting Fight Health Insurance</h4>
  <p style="font-size:1.05rem;">
    We're honored to help you fight for the care you deserve. If our service has been helpful, please consider supporting us:
  </p>
  <a href="https://buy.stripe.com/5kA03r2ZwbgebyE7ss" class="section-btn btn btn-default smoothScroll" id="support-our-dev-button" target="_blank" rel="noopener noreferrer" style="margin-top:1rem; display:inline-block; padding:10px 20px; font-size:1.05rem;">
    üíô Support Our Mission (Pay What You Want)
  </a>
</div>

<div class="appeal-donate-wrapper donate-wrapper">
  {% include 'partials/pwyw_panel.html' %}
</div>

<div style="margin:1.5rem 0; display:flex; justify-content:center; gap:1rem; align-items:center;">
  {% if back_url %}
  <a href="{{ back_url }}" class="btn btn-secondary" style="background:#6c757d; color:white; padding:10px 20px; border-radius:3px; text-decoration:none;">
    ‚Üê {{ back_label|default:"Back" }}
  </a>
  {% endif %}
  <a href="{% url 'scan' %}" class="btn btn-link" style="color:#6c757d; text-decoration:underline; font-size:0.9rem;">
    Start over with a new denial
  </a>
</div>

<div class="appeal-share-wrapper">
  {% include 'partials/share_buttons.html' %}
</div>
<p>
* We'll do our best to include a summary or abstract if available from PubMed.
</p>
{% endblock content %}
