{% extends 'single_optional_question.html' %}
{% block title %}
Optional: Health History
{% endblock title %}

{% load compress %}
{% load static %}

{% block formelm %}
<div class="form-group">
  <label for="health_history" class="form-label">
    <b>Optional</b>: Your Relevant Health History
    <small class="text-muted">(e.g. transgender, type 2 diabetes, fibromyalgia, etc.)</small>
  </label><br>
  <textarea name="health_history" id="health_history" style="width:100%" rows="20" form="fuck_health_insurance_form"
	    placeholder="Related Health History Goes Here" class="form-control"></textarea>
  <br>
</div>
<script type="module">
// Health history persistence with TTL
const TTL_MS = 24 * 60 * 60 * 1000;
const PERSISTENCE_KEY = "fhi_persistence_enabled";

function isPersistenceEnabled() {
  const stored = window.localStorage.getItem(PERSISTENCE_KEY);
  return stored !== "false";
}

function getWithTTL(key) {
  if (!isPersistenceEnabled()) return null;
  const stored = window.localStorage.getItem(key);
  if (!stored) return null;
  try {
    const parsed = JSON.parse(stored);
    if (parsed.expiry && Date.now() > parsed.expiry) {
      window.localStorage.removeItem(key);
      return null;
    }
    return parsed.value;
  } catch {
    return stored;
  }
}

function setWithTTL(key, value) {
  if (!isPersistenceEnabled()) return;
  const item = { value: value, expiry: Date.now() + TTL_MS };
  window.localStorage.setItem(key, JSON.stringify(item));
}

document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('health_history');
  if (textarea) {
    // Restore saved value
    const saved = getWithTTL('health_history');
    if (saved && textarea.value === '') {
      textarea.value = saved;
    }
    // Save on input
    textarea.addEventListener('input', function() {
      setWithTTL('health_history', textarea.value);
    });
  }
});
</script>
{% endblock formelm %}
