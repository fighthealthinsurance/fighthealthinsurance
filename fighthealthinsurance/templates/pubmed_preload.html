{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ heading }}</h1>
    <p class="lead">{{ description }}</p>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.medications.id_for_label }}">{{ form.medications.label }}</label>
                            {{ form.medications }}
                            <small class="text-muted">{{ form.medications.help_text }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.conditions.id_for_label }}">{{ form.conditions.label }}</label>
                            {{ form.conditions }}
                            <small class="text-muted">{{ form.conditions.help_text }}</small>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Search PubMed</button>
            </form>
        </div>
    </div>

    <div id="results-container" class="d-none">
        <div class="card">
            <div class="card-header">
                <h2>Search Results</h2>
                <div id="progress-info">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <small class="text-muted mt-1" id="progress-text">Searching PubMed...</small>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info" id="searching-message">
                    Searching PubMed... This may take a few minutes. Results will appear as they are retrieved.
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="filter-type">Filter by Type</label>
                            <select id="filter-type" class="form-control">
                                <option value="all">All</option>
                                <option value="medication">Medications Only</option>
                                <option value="condition">Conditions Only</option>
                                <option value="medication+condition">Combinations Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="sort-by">Sort by</label>
                            <select id="sort-by" class="form-control">
                                <option value="timestamp">Time Added</option>
                                <option value="unique_count">Number of Results</option>
                                <option value="term">Search Term</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="sort-order">Order</label>
                            <select id="sort-order" class="form-control">
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="results-table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Search Term</th>
                                <th>Type</th>
                                <th>Recent (2024+)</th>
                                <th>All Articles</th>
                                <th>Sample Articles</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="results-table">
                            <!-- Results will be inserted here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptmagic %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const resultsContainer = document.getElementById('results-container');
        const resultsTable = document.getElementById('results-table');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const searchingMessage = document.getElementById('searching-message');
        const filterType = document.getElementById('filter-type');
        const sortBy = document.getElementById('sort-by');
        const sortOrder = document.getElementById('sort-order');

        let allResults = [];

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Clear previous results
            allResults = [];
            resultsTable.innerHTML = '';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressText.textContent = 'Searching PubMed...';

            // Show results container
            resultsContainer.classList.remove('d-none');
            searchingMessage.classList.remove('d-none');

            // Create FormData from the form
            const formData = new FormData(form);

            // Build URL with form data as query parameters
            const baseUrl = form.action || window.location.href;
            const searchParams = new URLSearchParams();

            // Add form fields to the URL parameters
            for (const [key, value] of formData.entries()) {
                searchParams.append(key, value);
            }

            // Create the URL with parameters
            const sseUrl = `${baseUrl}?${searchParams.toString()}`;

            // Set up EventSource for Server-Sent Events with the constructed URL
            const eventSource = new EventSource(sseUrl);

            eventSource.onmessage = function(event) {
                console.log('Received event:', event);
                console.log('Received event data:', event.data);
                console.log("Trying to parse event data...");
                const data = JSON.parse(event.data);
                console.log('Parsed data:', data);

                if (data.status === 'started') {
                    // Initial setup
                    const total = data.total;
                    progressText.textContent = `0 of ${total} searches completed`;
                }
                else if (data.result) {
                    // Process a search result
                    const result = data.result;
                    allResults.push(result);

                    // Update progress
                    const completed = data.completed;
                    const total = data.total;
                    const percentage = Math.round((completed / total) * 100);

                    progressBar.style.width = `${percentage}%`;
                    progressBar.textContent = `${percentage}%`;
                    progressBar.setAttribute('aria-valuenow', percentage);
                    progressText.textContent = `${completed} of ${total} searches completed`;

                    // Update the table with filtered and sorted results
                    updateResultsTable();
                }
                else if (data.status === 'completed') {
                    // All searches completed
                    searchingMessage.classList.add('d-none');
                    eventSource.close();
                }
                console.log("Processed event");
            };

            eventSource.onerror = function() {
                console.error('Error receiving search results');
                progressText.textContent = 'Error receiving search results.';
                eventSource.close();
            };
        });

        // Add event listeners for filtering and sorting
        filterType.addEventListener('change', updateResultsTable);
        sortBy.addEventListener('change', updateResultsTable);
        sortOrder.addEventListener('change', updateResultsTable);

        function updateResultsTable() {
            // Filter results
            const selectedType = filterType.value;
            let filteredResults = allResults;

            if (selectedType !== 'all') {
                filteredResults = allResults.filter(result => result.type === selectedType);
            }

            // Sort results
            const sortField = sortBy.value;
            const sortDirection = sortOrder.value;

            filteredResults.sort((a, b) => {
                if (!a[sortField] && !b[sortField]) return 0;
                if (!a[sortField]) return sortDirection === 'asc' ? -1 : 1;
                if (!b[sortField]) return sortDirection === 'asc' ? 1 : -1;

                if (typeof a[sortField] === 'string') {
                    return sortDirection === 'asc'
                        ? a[sortField].localeCompare(b[sortField])
                        : b[sortField].localeCompare(a[sortField]);
                } else {
                    return sortDirection === 'asc'
                        ? a[sortField] - b[sortField]
                        : b[sortField] - a[sortField];
                }
            });

            // Clear and rebuild the table
            resultsTable.innerHTML = '';

            filteredResults.forEach(result => {
                const row = document.createElement('tr');

                // Add appropriate classes based on status
                if (result.status === 'error') {
                    row.classList.add('table-danger');
                }

                // Create the HTML content
                row.innerHTML = `
                    <td>${result.term}</td>
                    <td>${result.type}</td>
                    <td>${result.status === 'success' ? result.recent_count : '-'}</td>
                    <td>${result.status === 'success' ? result.unique_count :
                         `<span class="text-danger">${result.error || 'Error'}</span>`}</td>
                    <td>
                        ${result.status === 'success' && result.articles && result.articles.length > 0
                          ? result.articles.map(article =>
                              `<a href="${article.url}" target="_blank" rel="noopener noreferrer">${article.title}</a>`
                            ).join('<br>')
                          : '-'}
                    </td>
                    <td>${result.duration.toFixed(2)}s</td>
                `;

                resultsTable.appendChild(row);
            });
        }
    });
</script>
{% endblock %}
