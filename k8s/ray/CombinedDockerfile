ARG DEBIAN_FRONTEND=noninteractive
ARG RAY_VERSION
ARG MYORG

FROM ${MYORG}/fhi-ray:${RAY_VERSION}

USER root
# install some tools
RUN apt-get update && apt-get upgrade -y && apt-get install vim emacs libssl-dev python3-opencv libgl1 tesseract-ocr nano nfs-common iputils-ping hylafax-client build-essential pandoc texlive postgresql libpq-dev libcairo2-dev libgirepository1.0-dev python3-dev pkg-config -y
RUN apt-get install -y libmariadb-dev-compat
USER ray

# Copy hylafax settings
RUN mkdir -p /etc/hylafax
COPY hylafax-settings/* /etc/hylafax

# Installed seperately because only used in prod
COPY *requirements.txt ./
RUN $HOME/anaconda3/bin/pip install --upgrade pip
RUN $HOME/anaconda3/bin/pip install -r requirements.txt
RUN $HOME/anaconda3/bin/pip install -r deploy-requirements.txt
RUN mkdir -p ./fhi

COPY fighthealthinsurance ./fhi/fighthealthinsurance
COPY fhi_users ./fhi/fhi_users
COPY  charts ./fhi/charts
COPY setup.py ./fhi/setup.py
RUN $HOME/anaconda3/bin/pip install -e ./fhi/